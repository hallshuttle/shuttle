<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Halls Shuttle | Master Visual 2026</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style id="theme-engine">
        :root { --p: #E60012; --s: #007AFF; --bg: #1A1A1A; --card: #2A2A2A; --txt: #FFFFFF; }
    </style>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, system-ui, sans-serif; }
        body { background: var(--bg); color: var(--txt); overflow-x: hidden; font-weight: 600; transition: background 0.4s; }
        .status-bar { background: #000; padding: 8px 15px; font-size: 0.65rem; display: flex; justify-content: space-between; border-bottom: 2px solid var(--s); }
        .dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; background: #444; margin-right: 5px; }
        .on { background: #00ff00; box-shadow: 0 0 10px #00ff00; }
        header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--p); background: #111; }
        .logo { font-weight: 900; color: var(--p); font-size: 1.2rem; }
        .track { background: #000; padding: 30px 0; overflow-x: auto; display: flex; scroll-snap-type: x mandatory; scrollbar-width: none; border-bottom: 2px solid var(--card); }
        .stn { min-width: 33.33%; text-align: center; opacity: 0.3; scroll-snap-align: center; transition: 0.4s; position: relative; }
        .stn.active { opacity: 1; color: var(--s); transform: scale(1.1); font-weight: 900; }
        .stn-dot { width: 14px; height: 14px; background: #fff; border-radius: 50%; margin: 12px auto; }
        .active .stn-dot { background: var(--s); box-shadow: 0 0 15px var(--s); border: 2px solid #fff; }
        .view { display: none; padding: 20px; max-width: 500px; margin: 0 auto; }
        .view.active { display: block; }
        .card { background: var(--card); padding: 20px; border-radius: 4px; margin-bottom: 15px; border-left: 5px solid var(--s); }
        .btn { width: 100%; padding: 16px; border: none; font-weight: 900; cursor: pointer; text-transform: uppercase; margin-top: 10px; border-radius: 4px; }
        .btn-blue { background: var(--s); color: white; }
        .btn-red { background: var(--p); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--txt); color: var(--txt); }
        input, select, textarea { width: 100%; padding: 14px; background: #000; border: 2px solid #444; color: #fff; margin: 8px 0 18px 0; border-radius: 4px; }
        label { font-size: 0.7rem; color: var(--s); text-transform: uppercase; font-weight: 900; }
    </style>
</head>
<body>

    <div class="status-bar">
        <div><span id="c-dot" class="dot"></span> CLOUD: <span id="c-status">OFFLINE</span></div>
        <div><span id="p-dot" class="dot"></span> MESH ID: <span id="m-id">---</span></div>
    </div>

    <header><div class="logo" id="site-logo">HALLS CONSUL</div></header>

    <div id="metro-ui" class="track"></div>

    <div id="view-boot" class="view active">
        <h2>SYSTEM BOOT</h2>
        <button class="btn btn-blue" onclick="app.init('CLOUD')">CONNECT TO GLOBAL CLOUD</button>
        <div style="text-align:center; margin:20px; opacity:0.3; font-size:0.8rem;">-- OR P2P MESH --</div>
        <input type="text" id="m-target" placeholder="REMOTE PEER ID">
        <button class="btn btn-outline" onclick="app.init(document.getElementById('m-target').value)">JOIN MESH</button>
    </div>

    <div id="view-login" class="view">
        <h2>SECURE LOGIN</h2>
        <label>Operator ID / Email</label>
        <input type="text" id="u-id" placeholder="Enter your ID">
        <label>Security Pin</label>
        <input type="password" id="u-pin" placeholder="••••">
        <button class="btn btn-blue" onclick="app.login()">AUTHENTICATE</button>
    </div>

    <div id="view-passenger" class="view">
        <label>Pickup Station</label><select id="p-from" onchange="app.maskStops()"></select>
        <label>Destination Stop</label><select id="p-to"></select>
        <button class="btn btn-blue" onclick="app.request()">REQUEST RIDE</button>
        <div id="p-active"></div>
    </div>

    <div id="view-driver" class="view">
        <button class="btn btn-blue" id="d-btn" onclick="app.toggleDuty()">TOGGLE DUTY</button>
        <div id="d-queue"></div>
        <button class="btn btn-blue" style="background:white; color:black" onclick="app.next()">NEXT STATION</button>
    </div>

    <div id="view-admin" class="view">
        <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:5px; margin-bottom:20px;">
            <button class="btn btn-outline" style="font-size:0.5rem; padding:10px" onclick="app.adminTab('visual')">VISUAL</button>
            <button class="btn btn-outline" style="font-size:0.5rem; padding:10px" onclick="app.adminTab('theme')">THEME</button>
            <button class="btn btn-outline" style="font-size:0.5rem; padding:10px" onclick="app.adminTab('dna')">DNA</button>
            <button class="btn btn-outline" style="font-size:0.5rem; padding:10px" onclick="app.adminTab('ledger')">LOGS</button>
        </div>

        <div id="a-visual" class="a-tab">
            <div class="card">
                <label>Shuttle Name</label>
                <input type="text" id="v-sitename" onchange="app.vSyncInputs()">
                <label>Capacity</label>
                <input type="number" id="v-cap" onchange="app.vSyncInputs()">
            </div>
            
            <h3>STATIONS</h3>
            <div id="v-stations-list"></div>
            <button class="btn btn-blue" style="padding:10px; font-size:0.7rem; margin-bottom:20px;" onclick="app.vAddStation()">+ ADD STATION</button>

            <h3>FLEET USERS</h3>
            <div id="v-users-list"></div>
            <button class="btn btn-blue" style="padding:10px; font-size:0.7rem" onclick="app.vAddUser()">+ ADD NEW USER</button>
            
            <button class="btn btn-green" style="margin-top:40px; border: 3px solid white;" onclick="app.broadcast()">SAVE & BROADCAST CHANGES</button>
        </div>

        <div id="a-theme" class="a-tab" style="display:none">
            <h3>THEME ENGINE</h3>
            <div class="card">
                <label>Primary (Accent)</label><input type="color" id="t-p" onchange="app.tUpdate()">
                <label>Secondary (Utility)</label><input type="color" id="t-s" onchange="app.tUpdate()">
                <label>Background</label><input type="color" id="t-bg" onchange="app.tUpdate()">
                <div style="margin-top:15px; display:flex; align-items:center; gap:10px">
                   <input type="checkbox" id="t-night" style="width:20px; height:20px; margin:0" onchange="app.vSyncInputs()">
                   <label style="margin:0">Night Mode Force</label>
                </div>
                <button class="btn btn-green" style="margin-top:20px" onclick="app.broadcast()">APPLY THEME</button>
            </div>
        </div>

        <div id="a-dna" class="a-tab" style="display:none">
            <h3>MASTER DNA EDITOR</h3>
            <textarea id="dna-editor" style="height:350px; font-family:monospace; font-size:10px;"></textarea>
            <button class="btn btn-red" onclick="app.recode()">OVERWRITE DNA</button>
        </div>

        <div id="a-ledger" class="a-tab" style="display:none">
            <h3 id="stat-total">TRIPS: 0</h3>
            <div id="ledger-box" style="font-size:0.7rem; background:#000; padding:15px; height:200px; overflow-y:auto;"></div>
            <button class="btn btn-outline" onclick="app.purge()">PURGE SESSION</button>
        </div>
    </div>

    <script>
        const SB_URL = 'https://wltghngwfykdiwfzefaa.supabase.co'; 
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsdGdobmd3ZnlrZGl3ZnplZmFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4Mzk1NjYsImV4cCI6MjA4NDQxNTU2Nn0.WGP8NMxPRheytwipWCGeTBc7nfPJDESu_thFdqOp6qw';
        const sb = supabase.createClient(SB_URL, SB_KEY);

        const app = {
            peer: null, connections: [], 
            state: {
                stations: ["Chatteswari", "GEC Circle", "Khulshi", "Sitalpur"],
                users: [
                    {id: 'shuttle@halls.ac', name: 'Admin', pass: 'H@11$p2p2026', role: 'admin'},
                    {id: 'backup@halls.ac', name: 'Backup Manager', pass: 'SecureReset2026', role: 'admin'},
                    {id: 'driver', name: 'D. Miller', pass: '1234', role: 'driver', active: false},
                    {id: '555', name: 'User-1', pass: '1234', role: 'passenger'}
                ],
                config: { name: "Halls Consul", cap: 10, nightMode: false },
                theme: { p: "#E60012", s: "#007AFF", bg: "#1A1A1A" },
                trips: [], history: [], curIdx: 0, ts: Date.now()
            },
            user: null,

            async init(mode) {
                this.peer = new Peer();
                this.peer.on('open', (id) => {
                    document.getElementById('m-id').innerText = id.substring(0,8);
                    document.getElementById('p-dot').classList.add('on');
                    if(mode === 'CLOUD') this.cloudSync();
                    else this.peerConnect(mode);
                });
                this.peer.on('connection', (c) => {
                    this.connections.push(c);
                    c.on('open', () => c.send({type:'SYNC', state: this.state}));
                    c.on('data', (d) => this.handleSync(d));
                });
            },

            async cloudSync() {
                const { data } = await sb.from('shuttle_state').select('data').eq('id', 1).single();
                if(data) {
                    this.state = data.data;
                    document.getElementById('c-status').innerText = "LIVE";
                    document.getElementById('c-dot').classList.add('on');
                    this.showView('login');
                    this.render();
                }
                sb.channel('db').on('postgres_changes', { event:'UPDATE', schema:'public', table:'shuttle_state' }, 
                p => { if(p.new.data.ts > this.state.ts) { this.state = p.new.data; this.render(); } }).subscribe();
            },

            peerConnect(id) {
                const c = this.peer.connect(id);
                c.on('open', () => { this.connections.push(c); this.showView('login'); });
                c.on('data', (d) => this.handleSync(d));
            },

            handleSync(d) {
                if(d.type === 'SYNC' && d.state.ts > this.state.ts) {
                    this.state = d.state;
                    this.render();
                }
            },

            async broadcast() {
                this.state.ts = Date.now();
                this.connections.forEach(c => c.send({type:'SYNC', state: this.state}));
                await sb.from('shuttle_state').update({data: this.state}).eq('id', 1);
                this.render();
                alert("SYSTEM SYNCED SUCCESSFULLY");
            },

            login() {
                const id = document.getElementById('u-id').value;
                const pin = document.getElementById('u-pin').value;
                const u = this.state.users.find(x => x.id === id && x.pass === pin);
                if(u) { this.user = u; this.showView(u.role); this.render(); }
                else alert("LOGIN FAILED");
            },

            showView(v) {
                document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
                document.getElementById('view-' + v).classList.add('active');
            },

            render() {
                this.applyTheme();
                document.getElementById('site-logo').innerText = this.state.config.name;
                this.renderMetro();
                if(this.user?.role === 'passenger') this.renderPassenger();
                if(this.user?.role === 'driver') this.renderDriver();
                if(this.user?.role === 'admin') this.renderAdmin();
            },

            applyTheme() {
                const t = this.state.theme;
                const bg = this.state.config.nightMode ? "#000000" : t.bg;
                document.getElementById('theme-engine').innerHTML = `:root { --p: ${t.p}; --s: ${t.s}; --bg: ${bg}; --card: #2A2A2A; --txt: #FFFFFF; }`;
            },

            renderMetro() {
                const ui = document.getElementById('metro-ui'); ui.innerHTML = '';
                this.state.stations.forEach((s, i) => {
                    const wait = this.state.trips.filter(t => t.from === s && t.status === 'PENDING').length;
                    ui.innerHTML += `<div class="stn ${i === this.state.curIdx ? 'active' : ''}">
                        ${wait > 0 ? `<div style="position:absolute; top:-10px; right:20%; background:var(--p); color:white; border-radius:50%; width:18px; height:18px; font-size:0.6rem; display:flex; align-items:center; justify-content:center;">${wait}</div>` : ''}
                        <div class="stn-dot"></div><div style="font-size:0.6rem">${s.toUpperCase()}</div>
                    </div>`;
                });
            },

            renderAdmin() {
                // Config
                document.getElementById('v-sitename').value = this.state.config.name;
                document.getElementById('v-cap').value = this.state.config.cap;
                document.getElementById('t-p').value = this.state.theme.p;
                document.getElementById('t-s').value = this.state.theme.s;
                document.getElementById('t-bg').value = this.state.theme.bg;
                document.getElementById('t-night').checked = this.state.config.nightMode;
                
                // Station List
                const sList = document.getElementById('v-stations-list'); sList.innerHTML = '';
                this.state.stations.forEach((s, i) => {
                    sList.innerHTML += `<div style="display:flex; gap:5px; margin-bottom:5px">
                        <input type="text" value="${s}" onchange="app.state.stations[${i}]=this.value" style="margin:0">
                        <button class="btn-red" style="width:40px; margin:0; padding:0" onclick="app.vRemoveStation(${i})">X</button>
                    </div>`;
                });

                // User List
                const uList = document.getElementById('v-users-list'); uList.innerHTML = '';
                this.state.users.forEach((u, i) => {
                    uList.innerHTML += `<div class="card" style="padding:10px; font-size:0.8rem; border-left-width:3px; margin-bottom:5px;">
                        <span style="color:var(--s)">[${u.role.toUpperCase()}]</span> ${u.name} (${u.id})
                        <button class="btn-red" style="float:right; width:auto; padding:2px 10px; font-size:0.6rem; margin:0" onclick="app.vRemoveUser(${i})">DELETE</button>
                    </div>`;
                });

                document.getElementById('dna-editor').value = JSON.stringify(this.state, null, 2);
            },

            vSyncInputs() {
                this.state.config.name = document.getElementById('v-sitename').value;
                this.state.config.cap = parseInt(document.getElementById('v-cap').value);
                this.state.config.nightMode = document.getElementById('t-night').checked;
                this.applyTheme();
            },

            vAddStation() { 
                const n = prompt("Enter Station Name:"); 
                if(n) { this.state.stations.push(n); this.render(); }
            },
            vRemoveStation(i) {
                if(confirm("Delete this station?")) { this.state.stations.splice(i, 1); this.render(); }
            },

            vAddUser() {
                const role = prompt("Enter Role (admin, driver, passenger):", "passenger");
                const name = prompt("Enter Full Name:");
                const id = prompt("Enter ID / Email:");
                const pass = prompt("Enter Access PIN (4 digits):");
                
                if(role && name && id && pass) {
                    this.state.users.push({id, name, pass, role, active: false});
                    this.render();
                    alert(name + " added to the list. Click SAVE & BROADCAST to finish.");
                }
            },
            vRemoveUser(i) {
                if(confirm("Permanently delete this user?")) { this.state.users.splice(i, 1); this.render(); }
            },

            tUpdate() {
                this.state.theme.p = document.getElementById('t-p').value;
                this.state.theme.s = document.getElementById('t-s').value;
                this.state.theme.bg = document.getElementById('t-bg').value;
                this.applyTheme();
            },

            adminTab(t) {
                document.querySelectorAll('.a-tab').forEach(el => el.style.display = 'none');
                document.getElementById('a-' + t).style.display = 'block';
            },

            request() {
                this.state.trips.push({id: Date.now(), pId: this.user.id, from: document.getElementById('p-from').value, to: document.getElementById('p-to').value, status: 'PENDING'});
                this.broadcast();
            },

            next() {
                this.state.curIdx = (this.state.curIdx + 1) % this.state.stations.length;
                this.broadcast();
            },

            recode() { 
                try { 
                    this.state = JSON.parse(document.getElementById('dna-editor').value); 
                    this.broadcast(); 
                } catch(e) { alert("ERROR: INVALID DNA CODE"); }
            },

            purge() { if(confirm("Wipe logs?")) { this.state.history = []; this.broadcast(); } }
        };
    </script>
</body>
</html>
